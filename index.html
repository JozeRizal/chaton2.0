<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHAT ON - Asisten AI Berbasis PDF</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF.js from Mozilla for reading PDF files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>

    <!-- Markdown to HTML converter -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        /* Custom scrollbar for a cleaner look */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Spinner animation for loading indicator */
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner {
            border: 3px solid rgba(0,0,0,0.1);
            border-top-color: #3b82f6;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
        }
        .ai-thinking-dot { animation: bounce 1.4s infinite ease-in-out both; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .ai-thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .ai-thinking-dot:nth-child(2) { animation-delay: -0.16s; }
        
        /* Styling for AI response paragraphs */
        .ai-message-content p {
            margin-bottom: 0.75rem; /* 12px */
        }
        .ai-message-content p:last-child {
            margin-bottom: 0;
        }

        /* Preview Widget Styles */
        #preview-container {
            position: fixed;
            bottom: 25px;
            right: 25px;
            z-index: 9990;
        }
        #preview-bubble {
            height: 50px;
            background-color: #2563eb; /* Default color */
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.2s ease-in-out;
            padding: 0 20px 0 15px;
            gap: 8px;
            color: white;
            font-family: sans-serif;
            font-weight: 600;
            font-size: 16px;
        }
        #preview-bubble:hover { transform: scale(1.05); }
        #preview-bubble svg { color: white; width: 24px; height: 24px; flex-shrink: 0; }
        #preview-bubble.close-mode {
            width: 60px;
            height: 60px;
            padding: 0;
            border-radius: 50%;
            gap: 0;
        }
        #preview-window {
            position: absolute;
            bottom: 75px; /* Above the bubble */
            right: 0;
            width: 400px;
            max-width: calc(100vw - 40px);
            height: 600px;
            max-height: calc(100vh - 120px);
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
            z-index: 9999;
            background-color: white; /* PERUBAHAN: Kembali ke putih */
            display: flex;
            flex-direction: column;
        }
        #preview-window.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        /* Media query for mobile preview */
        @media (max-width: 640px) {
            #preview-window {
                width: calc(100vw - 40px);
            }
            #preview-container {
                bottom: 15px;
                right: 15px;
            }
        }
    </style>
</head>
<body class="bg-[#141414] min-h-screen font-sans text-white">

    <div class="w-full max-w-2xl mx-auto p-4">
        <!-- Main container -->
        <div id="app-container" class="bg-[#222222] rounded-2xl shadow-2xl overflow-hidden transition-all duration-500">

            <!-- ====================================================== -->
            <!-- 1. SETUP VIEW (For Website Owner)                      -->
            <!-- ====================================================== -->
            <div id="setup-view" class="p-8">
                <div class="text-center">
                    <h1 class="text-4xl font-bold text-[#E50914] tracking-wider">CHAT ON</h1>
                    <p class="text-gray-400 mt-2">Asisten AI Cerdas untuk Website Anda</p>
                </div>

                <!-- Step 1: API Key Input -->
                <div class="mt-8">
                     <label for="api-key-input" class="block text-sm font-medium text-gray-300 text-left mb-1">Langkah 1: Masukkan Kunci API</label>
                     <input type="password" id="api-key-input" class="w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E50914] focus:border-[#E50914] bg-gray-800 text-white" placeholder="Tempelkan Kunci API Google AI Anda di sini">
                     <p class="text-xs text-gray-500 mt-1 text-left">
                         Belum punya kunci? Dapatkan secara gratis di 
                         <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-[#E50914] hover:text-red-700">Google AI Studio</a>.
                     </p>
                </div>

                <!-- Step 2: PDF Upload -->
                <div class="mt-6 border-2 border-dashed border-gray-600 rounded-lg p-8 text-center bg-gray-800">
                    <svg class="mx-auto h-12 w-12 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h2 class="mt-4 text-xl font-semibold text-gray-200">Langkah 2: Unggah PDF</h2>
                    <p class="mt-1 text-sm text-gray-400">Pilih file PDF yang akan menjadi basis pengetahuan AI.</p>
                    
                    <div class="mt-6">
                        <input type="file" id="pdf-upload" class="hidden" accept=".pdf" />
                        <label for="pdf-upload" id="pdf-upload-button" class="bg-[#E50914] text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-red-700 focus:ring-offset-2 cursor-pointer inline-block">
                            Pilih File PDF
                        </label>
                    </div>
                </div>

                <!-- Step 3: Customization (Missing from original, but implied by preview logic) -->
                <div class="mt-6">
                    <h2 class="text-xl font-semibold text-gray-200 text-left mb-4">Langkah 3: Kustomisasi Tampilan (Opsional)</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="assistant-name-input" class="block text-sm font-medium text-gray-300 mb-1">Nama Asisten</label>
                            <input type="text" id="assistant-name-input" class="w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E50914] focus:border-[#E50914] bg-gray-800 text-white" placeholder="CHAT ON">
                        </div>
                        <div>
                            <label for="button-text-input" class="block text-sm font-medium text-gray-300 mb-1">Teks Tombol Chat</label>
                            <input type="text" id="button-text-input" class="w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E50914] focus:border-[#E50914] bg-gray-800 text-white" placeholder="Tanya CS">
                        </div>
                        <!-- BARU: Avatar Upload -->
                        <div class="md:col-span-2">
                            <label for="avatar-upload-input" class="block text-sm font-medium text-gray-300 mb-1">Avatar Asisten (Opsional, < 2MB)</label>
                            <div class="flex items-center gap-3">
                                <input type="file" id="avatar-upload-input" accept="image/png, image/jpeg, image/gif" class="block w-full text-sm text-gray-400
                                    file:mr-4 file:py-2 file:px-4
                                    file:rounded-lg file:border-0
                                    file:text-sm file:font-semibold
                                    file:bg-red-200 file:text-red-800
                                    hover:file:bg-red-300 cursor-pointer
                                "/>
                                <img id="avatar-preview-setup" src="" alt="Avatar" class="h-10 w-10 rounded-full object-cover hidden bg-gray-600 flex-shrink-0">
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <label for="welcome-message-input" class="block text-sm font-medium text-gray-300 mb-1">Pesan Selamat Datang</label>
                            <input type="text" id="welcome-message-input" class="w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E50914] focus:border-[#E50914] bg-gray-800 text-white" placeholder="Halo! Saya asisten AI. Silakan ajukan pertanyaan.">
                        </div>
                        <div>
                            <label for="theme-color-input" class="block text-sm font-medium text-gray-300 mb-1">Warna Tema</label>
                            <input type="color" id="theme-color-input" class="w-full h-10 px-1 py-1 border border-gray-600 rounded-lg cursor-pointer" value="#2563eb">
                        </div>
                        <!-- BARU: Subjudul Asisten -->
                        <div>
                            <label for="assistant-subtitle-input" class="block text-sm font-medium text-gray-300 mb-1">Subjudul Asisten</label>
                            <input type="text" id="assistant-subtitle-input" class="w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E50914] focus:border-[#E50914] bg-gray-800 text-white" placeholder="Asisten Virtual">
                        </div>
                    </div>
                </div>

                <div class="mt-6 text-center">
                    <div class="flex flex-col sm:flex-row sm:justify-center sm:space-x-4 space-y-3 sm:space-y-0">
                        <button id="preview-button" class="bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2">
                            Pratinjau Tampilan
                        </button>
                        <button id="generate-button" class="bg-[#E50914] text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-red-700 focus:ring-offset-2">
                            Buat Kode Widget
                        </button>
                    </div>
                </div>

                <div id="upload-status" class="mt-6 text-center text-sm min-h-[20px]"></div>
            </div>

            <!-- ====================================================== -->
            <!-- 2. EMBED VIEW (After Upload)                 -->
            <!-- ====================================================== -->
            <div id="embed-view" class="hidden p-8 text-center">
                 <svg class="mx-auto h-12 w-12 text-green-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                 <h2 class="mt-4 text-xl font-semibold text-gray-200">Berhasil! Widget Siap Digunakan</h2>
                 <p class="mt-1 text-sm text-gray-400">Salin kode di bawah ini dan tempelkan ke dalam editor HTML di website Anda.</p>
                
                 <div class="mt-6 text-left">
                     <label for="embed-code" class="block text-sm font-medium text-gray-300 mb-1">Kode Widget Pop-up</label>
                     <textarea id="embed-code" readonly class="w-full h-40 p-3 font-mono text-xs bg-gray-800 text-gray-300 border border-gray-600 rounded-md resize-none focus:outline-none focus:ring-2 focus:ring-[#E50914] focus:border-[#E50914]"></textarea>
                 </div>
                 <div class="mt-4 flex flex-col sm:flex-row sm:justify-center sm:space-x-4 space-y-3 sm:space-y-0">
                     <button id="back-to-setup-button" class="bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2">
                         Kembali & Edit
                     </button>
                     <button id="copy-button" class="bg-[#E50914] text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-red-700 focus:ring-offset-2">
                         Salin Kode
                     </button>
                 </div>
                 <!-- Pesan "Coba" akan ditambahkan di sini oleh JS -->
            </div>

        </div>
        <!-- Footer -->
        <div class="text-center text-gray-500 text-xs mt-4">
            Â© 2025. CHAT ON v2.0 by Joze Rizal
        </div>
    </div>

    <!-- Preview Widget (Initially Hidden) -->
    <div id="preview-container" class="hidden">
        <div id="preview-bubble" style="background-color: rgb(37, 99, 235);">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
            <span>Tanya CS</span>
        </div>
        <div id="preview-window">
            <!-- Header -->
            <div id="preview-header" class="p-4 flex items-center justify-between text-white shadow-md flex-shrink-0" style="background-color: rgb(37, 99, 235);">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-green-400 rounded-full border-2 border-white"></div>
                    <div>
                        <h2 id="preview-assistant-name" class="font-bold text-lg">CHAT ON</h2>
                        <!-- PERUBAHAN: Menambahkan ID di sini -->
                        <p id="preview-assistant-subtitle" class="text-xs opacity-80">Asisten Virtual</p>
                    </div>
                </div>
            </div>
            <!-- Messages -->
            <div class="flex-grow p-4 overflow-y-auto custom-scrollbar bg-slate-50 h-full"> <!-- PERUBAHAN: Kembali ke bg-slate-50 -->
                <div class="flex items-start gap-3 mb-4">
                    <!-- PERUBAHAN: Bungkus avatar text dan tambahkan avatar image -->
                    <div class="w-8 h-8 rounded-full flex-shrink-0 object-cover overflow-hidden">
                        <div id="preview-avatar-text" class="w-full h-full bg-indigo-600 text-white flex items-center justify-center font-bold text-sm">AI</div> <!-- PERUBAHAN: Kembali ke bg-indigo-600 -->
                        <img id="preview-avatar-img" src="" alt="Avatar" class="w-full h-full rounded-full object-cover hidden">
                    </div>
                    <div class="bg-white p-3 rounded-lg rounded-tl-none shadow-sm max-w-xs md:max-w-md"> <!-- PERUBAHAN: Kembali ke bg-white -->
                        <p id="preview-welcome-message" class="text-slate-700">Halo! Saya asisten AI. Silakan ajukan pertanyaan.</p> <!-- PERUBAHAN: Kembali ke text-slate-700 -->
                    </div>
                </div>
            </div>
            <!-- Input -->
            <div class="p-4 border-t border-slate-200 bg-white flex-shrink-0"> <!-- PERUBAHAN: Kembali ke bg-white & border-slate-200 -->
                <div class="flex items-center gap-3">
                    <input type="text" disabled="" placeholder="Ketik pertanyaan Anda..." class="w-full px-4 py-2 border border-slate-300 rounded-full bg-slate-100 cursor-not-allowed"> <!-- PERUBAHAN: Kembali ke style-slate -->
                    <button type="button" disabled="" class="text-white rounded-full p-3 bg-slate-400 cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const setupView = document.getElementById('setup-view');
        const embedView = document.getElementById('embed-view');
        const apiKeyInput = document.getElementById('api-key-input');
        const pdfUploadInput = document.getElementById('pdf-upload');
        const uploadStatus = document.getElementById('upload-status');
        const embedCodeTextarea = document.getElementById('embed-code');
        const copyButton = document.getElementById('copy-button');
        const backToSetupButton = document.getElementById('back-to-setup-button'); // Tombol kembali

        // Preview Elements
        const previewButton = document.getElementById('preview-button');
        const generateButton = document.getElementById('generate-button'); // Tombol baru
        const previewContainer = document.getElementById('preview-container');
        const previewWindow = document.getElementById('preview-window');
        const previewBubble = document.getElementById('preview-bubble'); // <-- PERBAIKAN: Variabel yang hilang ditambahkan
        const previewHeader = document.getElementById('preview-header');
        const previewAssistantName = document.getElementById('preview-assistant-name');
        const previewWelcomeMessage = document.getElementById('preview-welcome-message');
        const previewAvatarText = document.getElementById('preview-avatar-text'); // <-- BARU
        const previewAssistantSubtitle = document.getElementById('preview-assistant-subtitle'); // BARU

        // Customization Inputs
        const assistantNameInput = document.getElementById('assistant-name-input');
        const buttonTextInput = document.getElementById('button-text-input');
        const welcomeMessageInput = document.getElementById('welcome-message-input');
        const themeColorInput = document.getElementById('theme-color-input');
        const avatarUploadInput = document.getElementById('avatar-upload-input'); // BARU
        const avatarPreviewSetup = document.getElementById('avatar-preview-setup'); // BARU
        const assistantSubtitleInput = document.getElementById('assistant-subtitle-input'); // BARU
        
        let processedPdfText = null; // Menyimpan teks PDF yang diproses
        let processedAvatarBase64 = null; // BARU: Menyimpan avatar base64

        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

        pdfUploadInput.addEventListener('change', handlePdfUpload);
        avatarUploadInput.addEventListener('change', handleAvatarUpload); // BARU
        copyButton.addEventListener('click', copyEmbedCode);
        backToSetupButton.addEventListener('click', backToSetup); // Listener baru
        previewButton.addEventListener('click', showPreview);
        generateButton.addEventListener('click', generateWidgetCode); // Event listener baru
        previewBubble.addEventListener('click', togglePreviewWidget);

        async function handlePdfUpload(event) {
            // TIDAK perlu Kunci API atau kustomisasi di sini lagi
            
            // --- PERBAIKAN: Tambahkan baris ini untuk mendapatkan file dari event ---
            const file = event.target.files[0];
            if (!file) {
                updateStatus('Error: Tidak ada file yang dipilih.', 'error');
                processedPdfText = null; // Reset jika batal
                return;
            }
            // --- Akhir Perbaikan ---

            updateStatus('Membaca file...', 'loading');
            processedPdfText = null; // Reset untuk file baru

            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const typedarray = new Uint8Array(e.target.result);
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            updateStatus(`Mengekstrak teks halaman ${i}/${pdf.numPages}...`, 'loading');
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += pageText.replace(/\s+/g, ' ') + ' ';
                        }
                        
                        // onPdfProcessed(fullText.trim(), apiKey, assistantName, welcomeMessage, buttonText, themeColor);
                        // ---- PERUBAHAN: Simpan teks dan beri status sukses ----
                        processedPdfText = fullText.trim();
                        updateStatus(`Berhasil memuat file: ${file.name}`, 'success');
                        // ---------------------------------------------------

                    } catch (pdfError) {
                         console.error('Error saat memproses PDF:', pdfError);
                         updateStatus('Gagal memproses file PDF. Mungkin file rusak.', 'error');
                         processedPdfText = null; // Reset jika gagal
                    }
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('Error membaca file:', error);
                updateStatus('Gagal membaca file. Silakan coba lagi.', 'error');
                processedPdfText = null; // Reset jika gagal
            }
        }

        // --- FUNGSI BARU: Untuk menangani upload avatar ---
        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                processedAvatarBase64 = null;
                avatarPreviewSetup.classList.add('hidden');
                avatarPreviewSetup.src = '';
                return;
            }

            if (file.size > 2_000_000) { // Batas 2MB
                updateStatus('Error: Ukuran file avatar terlalu besar (Maks 2MB).', 'error');
                processedAvatarBase64 = null;
                avatarPreviewSetup.classList.add('hidden');
                avatarPreviewSetup.src = '';
                avatarUploadInput.value = ''; // Reset input
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                processedAvatarBase64 = e.target.result; // Ini adalah string Base64
                avatarPreviewSetup.src = processedAvatarBase64;
                avatarPreviewSetup.classList.remove('hidden');
                updateStatus('Avatar berhasil dimuat.', 'success'); // Beri tahu pengguna
            };
            reader.onerror = () => {
                updateStatus('Error: Gagal membaca file avatar.', 'error');
                processedAvatarBase64 = null;
                avatarPreviewSetup.classList.add('hidden');
                avatarPreviewSetup.src = '';
            };
            reader.readAsDataURL(file);
        }
        // --- AKHIR FUNGSI BARU ---

        // --- FUNGSI BARU: Untuk membuat kode widget ---
        function generateWidgetCode() {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                updateStatus('Error: Mohon masukkan Kunci API Anda (Langkah 1).', 'error');
                return;
            }

            if (!processedPdfText) {
                updateStatus('Error: Mohon unggah file PDF (Langkah 2) terlebih dahulu.', 'error');
                return;
            }

            // Dapatkan nilai kustomisasi SEKARANG, saat tombol diklik
            const assistantName = document.getElementById('assistant-name-input').value.trim() || 'CHAT ON';
            const welcomeMessage = document.getElementById('welcome-message-input').value.trim() || 'Halo! Saya asisten AI. Silakan ajukan pertanyaan.';
            const buttonText = document.getElementById('button-text-input').value.trim() || 'Tanya CS';
            const themeColor = document.getElementById('theme-color-input').value || '#2563eb';
            const avatarBase64 = processedAvatarBase64; // BARU: Dapatkan data avatar
            const assistantSubtitle = document.getElementById('assistant-subtitle-input').value.trim() || 'Asisten Virtual'; // BARU

            // Panggil onPdfProcessed dengan semua data yang sudah siap
            onPdfProcessed(processedPdfText, apiKey, assistantName, welcomeMessage, buttonText, themeColor, avatarBase64, assistantSubtitle); // BARU: Tambahkan assistantSubtitle
        }
        // --- AKHIR FUNGSI BARU ---

        function onPdfProcessed(pdfText, apiKey, assistantName, welcomeMessage, buttonText, themeColor, avatarBase64, assistantSubtitle) { // BARU: Tambahkan assistantSubtitle
            updateStatus('Membuat kode widget...', 'loading');

            // Hide preview widget if it's open
            previewContainer.classList.add('hidden');
            
            const encodedPdfData = btoa(encodeURIComponent(pdfText));
            const encodedWelcomeMsg = welcomeMessage.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const encodedAssistantName = assistantName.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const encodedAssistantSubtitle = assistantSubtitle.replace(/</g, "&lt;").replace(/>/g, "&gt;"); // BARU
            const encodedAvatarData = avatarBase64 ? btoa(encodeURIComponent(avatarBase64)) : ''; // BARU: Encode data avatar

            const iframeHtml = `
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHAT ON</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"><\/script>
    <style>
        .custom-scrollbar::-webkit-scrollbar{width:6px;}.custom-scrollbar::-webkit-scrollbar-track{background:#f1f5f9;}.custom-scrollbar::-webkit-scrollbar-thumb{background:#94a3b8;border-radius:3px;}.ai-thinking-dot{animation:bounce 1.4s infinite ease-in-out both;}@keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1.0)}}.ai-thinking-dot:nth-child(1){animation-delay:-.32s;}.ai-thinking-dot:nth-child(2){animation-delay:-.16s;}
        .ai-message-content p { margin-bottom: 0.75rem; }
        .ai-message-content p:last-child { margin-bottom: 0; }
    <\/style>
<\/head>
<body class="font-sans text-sm"> <!-- PERUBAHAN: Menghapus text-white -->
    <div id="pdf-data" style="display:none;">${encodedPdfData}<\/div>
    <div id="api-key-data" style="display:none;">${apiKey}<\/div>
    <div id="theme-color-data" style="display:none;">${themeColor}<\/div>
    <div id="avatar-data" style="display:none;">${encodedAvatarData}<\/div> <!-- BARU -->
    <div class="h-screen w-screen flex flex-col bg-white"> <!-- PERUBAHAN: Kembali ke bg-white -->
        <div id="chat-header" class="p-4 flex items-center justify-between text-white shadow-md flex-shrink-0" style="background-color: ${themeColor};">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 bg-green-400 rounded-full border-2 border-white"></div>
                <!-- PERUBAHAN: Masukkan subjudul yang di-encode -->
                <div><h2 id="assistant-name-header" class="font-bold text-lg">${encodedAssistantName}<\/h2><p class="text-xs opacity-80">${encodedAssistantSubtitle}<\/p></div>
            </div>
            <button id="close-chat-btn" class="sm:hidden p-1 text-white rounded-full hover:bg-white/20">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div id="chat-messages" class="flex-grow p-4 overflow-y-auto custom-scrollbar bg-slate-50"> <!-- PERUBAHAN: Kembali ke bg-slate-50 -->
            <div class="flex items-start gap-3 mb-4">
                <!-- PERUBAHAN: Container avatar ini akan diisi oleh JS -->
                <div id="welcome-avatar-container" class="w-8 h-8 rounded-full flex-shrink-0 object-cover overflow-hidden">
                    <!-- Ini akan diisi oleh JS di bawah -->
                </div>
                <div class="bg-white p-3 rounded-lg rounded-tl-none shadow-sm max-w-xs md:max-w-md"><p id="welcome-message-bubble" class="text-slate-700">${encodedWelcomeMsg}<\/p></div> <!-- PERUBAHAN: Kembali ke bg-white & text-slate-700 -->
            </div>
        </div>
        <div class="p-4 border-t border-slate-200 bg-white flex-shrink-0"> <!-- PERUBAHAN: Kembali ke bg-white & border-slate-200 -->
            <form id="chat-form" class="flex items-center gap-3">
                <input type="text" id="chat-input" placeholder="Ketik pertanyaan Anda..." autocomplete="off" class="w-full px-4 py-2 border border-slate-300 rounded-full focus:outline-none focus:ring-2" style="--tw-ring-color: ${themeColor};"> <!-- PERUBAHAN: Menghapus style dark, kembali ke border-slate-300 -->
                <button id="send-button" type="submit" class="text-white rounded-full p-3 hover:opacity-90 disabled:bg-slate-400 transition-colors" style="background-color: ${themeColor};"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"><\/line><polygon points="22 2 15 22 11 13 2 9 22 2"><\/polygon><\/svg></button>
            </form>
        </div>
    </div>
    <script>
        const pdfTextContent = decodeURIComponent(atob(document.getElementById('pdf-data').textContent));
        const apiKey = document.getElementById('api-key-data').textContent;
        const avatarBase64 = document.getElementById('avatar-data').textContent ? decodeURIComponent(atob(document.getElementById('avatar-data').textContent)) : null; // BARU
        let chatHistory = [];
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const sendButton = chatForm.querySelector('button');
        const closeButton = document.getElementById('close-chat-btn');
        const themeColor = document.getElementById('theme-color-data').textContent;
        const assistantName = document.getElementById('assistant-name-header').textContent || 'AI'; // BARU

        // --- BARU: Fungsi untuk membuat HTML Avatar ---
        function getAvatarHtml() {
            if (avatarBase64) {
                return \`<img src="\${avatarBase64}" alt="Avatar" class="w-full h-full rounded-full object-cover">\`;
            } else {
                const avatarText = assistantName.substring(0, 2).toUpperCase();
                return \`<div class="w-full h-full bg-indigo-600 text-white flex items-center justify-center font-bold text-sm">\${avatarText}<\/div>\`; /* PERUBAHAN: Kembali ke bg-indigo-600 */
            }
        }

        // --- BARU: Set avatar selamat datang ---
        document.getElementById('welcome-avatar-container').innerHTML = getAvatarHtml();

        if (themeColor) {
            chatInput.addEventListener('focus', () => chatInput.style.borderColor = themeColor);
            chatInput.addEventListener('blur', () => chatInput.style.borderColor = '');
        }

        const systemInstruction = {
            parts: [{ text: "Anda adalah '" + assistantName + "', asisten AI yang ramah dan membantu. Tugas utama Anda adalah menjawab pertanyaan pengguna HANYA berdasarkan konteks yang diberikan (" + pdfTextContent + "). Jangan pernah memberikan informasi di luar konteks ini. Jika jawaban tidak ada dalam konteks, katakan dengan sopan bahwa Anda tidak dapat menemukan informasi tersebut. Jawaban harus dalam bahasa Indonesia. PENTING: Jangan gunakan format Markdown seperti tanda bintang (*) untuk membuat daftar atau bold. Jawablah dalam bentuk paragraf yang rapi dan mudah dibaca." }]
        }; // --- PERBAIKAN: Menambahkan titik koma (;) yang hilang
            
        // --- PERBAIKAN: Menambahkan baris event listener yang hilang ---
        chatForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const userMessage = chatInput.value.trim();
            if (!userMessage || !apiKey) return;
            
            addMessageToUI("user", userMessage);
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
            chatInput.value = "";
            sendButton.disabled = true;
            const thinkingIndicator = showThinkingIndicator();
            
            try {
                // --- PERBAIKAN: Mengganti 'generativelace' menjadi 'generativelanguage' ---
                const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + apiKey, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: chatHistory, systemInstruction: systemInstruction })
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    // --- PERBAIKAN: Memperbaiki kesalahan sintaks "D +" menjadi " + ---
                    throw new Error("API request failed: " + (errorBody.error?.message || response.statusText));
                }
                const result = await response.json();
                const aiMessage = result.candidates[0].content.parts[0].text;
                chatHistory.push({ role: "model", parts: [{ text: aiMessage }] });
                addMessageToUI("ai", aiMessage);
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                addMessageToUI("ai", "Maaf, terjadi kesalahan. Pastikan Kunci API Anda valid dan coba lagi.");
            } finally {
                removeThinkingIndicator(thinkingIndicator);
                sendButton.disabled = false;
            }
        });

        function addMessageToUI(sender, message) {
            const element = document.createElement("div");
            element.className = "flex items-start gap-3 mb-4";
            if (sender === "user") {
                element.classList.add("justify-end");
                const sanitizedMsg = message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                // --- PERUBAHAN: Mengganti 'bg-blue-600' dengan style inline \${themeColor} ---
                element.innerHTML = \`<div style="background-color: \${themeColor};" class="text-white p-3 rounded-lg rounded-br-none shadow-sm max-w-xs md:max-w-md"><p>\${sanitizedMsg}<\/p><\/div><div class="w-8 h-8 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center font-bold flex-shrink-0">Anda<\/div>\`; /* PERUBAHAN: Avatar 'Anda' kembali ke style slate */
            } else {
                // --- BARU: Dapatkan avatar dari nama header ---
                // const avatarText = (document.getElementById('assistant-name-header')?.textContent || 'AI').substring(0, 2).toUpperCase(); // <-- DIHAPUS
                // --- AKHIR BARU ---
                const htmlMessage = marked.parse(message);
                // --- PERUBAHAN: Gunakan fungsi getAvatarHtml() ---
                element.innerHTML = \`<div class="w-8 h-8 rounded-full flex-shrink-0 object-cover overflow-hidden">\${getAvatarHtml()}<\/div><div class="bg-white p-3 rounded-lg rounded-tl-none shadow-sm max-w-xs md:max-w-md ai-message-content"><div class="text-slate-700">\${htmlMessage}<\/div><\/div>\`; /* PERUBAHAN: Bubble AI kembali ke bg-white & text-slate-700 */
            }
            chatMessages.appendChild(element);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        function showThinkingIndicator() {
            const indicator = document.createElement("div");
            indicator.className = "flex items-start gap-3 mb-4";
            // --- PERUBAHAN: Gunakan fungsi getAvatarHtml() ---
            indicator.innerHTML = \`<div class="w-8 h-8 rounded-full flex-shrink-0 object-cover overflow-hidden">\${getAvatarHtml()}<\/div><div class="bg-white p-3 rounded-lg rounded-tl-none shadow-sm flex items-center space-x-1"><div class="w-2 h-2 bg-slate-400 rounded-full ai-thinking-dot"><\/div><div class="w-2 h-2 bg-slate-400 rounded-full ai-thinking-dot"><\/div><div class="w-2 h-2 bg-slate-400 rounded-full ai-thinking-dot"><\/div><\/div>\`; /* PERUBAHAN: Bubble 'thinking' kembali ke bg-white & bg-slate-400 */
            chatMessages.appendChild(indicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return indicator;
        }
        function removeThinkingIndicator(indicator) { if(indicator) {indicator.remove();} }
        
        // --- Menambahkan listener untuk tombol close di mobile ---
        if (closeButton) {
            closeButton.addEventListener('click', () => {
                // Mengirim pesan ke window utama untuk menutup
                window.parent.postMessage('close-chat-on-widget', '*');
            });
        }
    <\/script>
<\/body>
<\/html>
`;

            const finalBase64Html = btoa(iframeHtml);

            const embedScript = `<!-- Kode Widget CHAT ON -->
<div id="chat-on-container"></div>
<script>
(function() {
    const b64content = "${finalBase64Html}";
    const buttonText = "${buttonText}";
    const themeColor = "${themeColor}";
    const container = document.getElementById('chat-on-container');
    if (!container) { return; }

    const styles = \`
        #chat-on-bubble { position: fixed; bottom: 25px; right: 25px; height: 50px; background-color: \${themeColor}; border-radius: 25px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: all 0.2s ease-in-out; z-index: 9998; padding: 0 20px 0 15px; gap: 8px; color: white; font-family: sans-serif; font-weight: 600; font-size: 16px; }
        #chat-on-bubble:hover { transform: scale(1.05); }
        #chat-on-bubble svg { color: white; width: 24px; height: 24px; flex-shrink: 0; }
        #chat-on-bubble.close-mode { width: 60px; height: 60px; padding: 0; border-radius: 50%; gap: 0; }
        #chat-on-window { position: fixed; bottom: 100px; right: 25px; width: 400px; max-width: calc(100% - 40px); height: 600px; max-height: calc(100% - 120px); border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); overflow: hidden; opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease; pointer-events: none; z-index: 9999; }
        #chat-on-window.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
        @media (max-width: 640px) { #chat-on-window { width: 100%; height: 100%; max-height: 100%; top: 0; right: 0; bottom: 0; left: 0; border-radius: 0; } #chat-on-bubble { bottom: 15px; right: 15px; } }
    \`;

    const chatIcon = \`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"><\\/path><\\/svg><span>\${buttonText}<\/span>\`;
    const closeIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"><\\/line><line x1="6" y1="6" x2="18" y2="18"><\\/line><\\/svg>';

    container.innerHTML = \`<div id="chat-on-bubble">\${chatIcon}<\/div><div id="chat-on-window"><iframe style="border:none; width:100%; height:100%;" title="CHAT ON Assistant"><\\/iframe></div>\`;
    
    // --- PERBAIKAN: Dapatkan iframe setelah dibuat dan atur srcdoc ---
    const iframe = container.querySelector('iframe');
    if (iframe) {
        try { 
            iframe.srcdoc = atob(b64content); 
        } catch (e) { 
            console.error("Gagal memuat konten widget.", e); 
        }
    } else {
        console.error("Tidak dapat menemukan iframe widget.");
    }
    // --- Akhir Perbaikan ---

    const styleSheet = document.createElement("style");
    // --- PERUBAHAN: Menambahkan ID agar bisa dihapus saat diunggah ulang ---
    styleSheet.id = "chat-on-widget-style";
    styleSheet.innerText = styles;
    document.head.appendChild(styleSheet);

    const bubble = document.getElementById('chat-on-bubble');
    const chatWindow = document.getElementById('chat-on-window');
    
    bubble.addEventListener('click', () => {
        const isActive = chatWindow.classList.toggle('active');
        if (isActive) {
            bubble.classList.add('close-mode');
            bubble.innerHTML = closeIcon;
        } else {
            bubble.classList.remove('close-mode');
            bubble.innerHTML = chatIcon;
        }
    });

    window.addEventListener('message', function(event) {
        if (event.data === 'close-chat-on-widget') {
            chatWindow.classList.remove('active');
            bubble.classList.remove('close-mode');
            bubble.innerHTML = chatIcon;
        }
    });
})();
<`+`/script>`;
            
            embedCodeTextarea.value = embedScript;
            setupView.classList.add('hidden');
            embedView.classList.remove('hidden');
            updateStatus('Selesai! Widget Anda siap digunakan.', 'success');

            // --- KODE BARU DIMULAI: Injeksi Live Preview ---

            // 1. Hapus preview desain (yang tidak interaktif)
            previewContainer.classList.add('hidden');

            // 2. Hapus widget live-preview sebelumnya (jika pengguna mengunggah ulang PDF)
            const existingContainer = document.getElementById('chat-on-container');
            if (existingContainer) existingContainer.remove();
            
            const existingStyle = document.getElementById('chat-on-widget-style');
            if (existingStyle) existingStyle.remove();
            
            const existingTryIt = document.getElementById('try-it-message');
            if (existingTryIt) existingTryIt.remove();
            
            // 3. Ekstrak HTML container dan konten skrip dari kode embed
            const containerMatch = embedScript.match(/<div id="chat-on-container">.*?<\/div>/s);
            const scriptMatch = embedScript.match(/<script>([\s\S]*?)<\/script>/);

            if (containerMatch && scriptMatch && scriptMatch[1]) {
                
                // 4. Tambahkan div container ke body
                // Kita gunakan trik ini untuk mengubah string HTML menjadi elemen DOM
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = containerMatch[0];
                const liveContainer = tempDiv.firstElementChild;
                if (liveContainer) {
                    document.body.appendChild(liveContainer);
                }

                // 5. Buat dan tambahkan skrip agar bisa dieksekusi
                const scriptContent = scriptMatch[1];
                const livePreviewScript = document.createElement('script');
                livePreviewScript.textContent = scriptContent;
                // Kita tambahkan ke body agar dieksekusi setelah container ada
                document.body.appendChild(livePreviewScript);
                
                // 6. Beri tahu pengguna bahwa mereka bisa mencobanya
                const tryItText = document.createElement('p');
                tryItText.textContent = 'Widget Anda kini aktif di sudut kanan bawah halaman ini untuk Anda coba.';
                tryItText.className = 'text-center text-blue-600 font-semibold mt-2';
                tryItText.id = 'try-it-message';
                embedView.appendChild(tryItText); // Menambahkan pesan di dalam #embed-view
            } else {
                console.error("Gagal mengekstrak skrip untuk live preview.");
            }
            // --- KODE BARU SELESAI ---
        }

        function copyEmbedCode() {
            embedCodeTextarea.select();
            document.execCommand('copy');
            copyButton.textContent = 'Berhasil Disalin!';
            setTimeout(() => { copyButton.textContent = 'Salin Kode'; }, 2000);
        }

        const previewCloseIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';

        function showPreview() {
            // Get current values
            const assistantName = assistantNameInput.value.trim() || 'CHAT ON';
            const buttonText = buttonTextInput.value.trim() || 'Tanya CS';
            const welcomeMessage = welcomeMessageInput.value.trim() || 'Halo! Saya asisten AI. Silakan ajukan pertanyaan.';
            const themeColor = themeColorInput.value || '#2563eb';
            const avatarBase64 = processedAvatarBase64; // BARU
            const assistantSubtitle = assistantSubtitleInput.value.trim() || 'Asisten Virtual'; // BARU

            // Dapatkan elemen avatar preview
            const previewAvatarTextEl = document.getElementById('preview-avatar-text'); // BARU
            const previewAvatarImgEl = document.getElementById('preview-avatar-img'); // BARU

            // Update preview elements
            previewHeader.style.backgroundColor = themeColor;
            previewBubble.style.backgroundColor = themeColor;
            previewAssistantName.textContent = assistantName;
            previewAssistantSubtitle.textContent = assistantSubtitle; // BARU
            previewWelcomeMessage.textContent = welcomeMessage;
            // previewAvatarText.textContent = assistantName.substring(0, 2).toUpperCase(); // <-- LAMA
            
            // --- BARU: Logika untuk menampilkan avatar ---
            if (avatarBase64) {
                previewAvatarImgEl.src = avatarBase64;
                previewAvatarImgEl.classList.remove('hidden');
                previewAvatarTextEl.classList.add('hidden');
            } else {
                previewAvatarTextEl.textContent = assistantName.substring(0, 2).toUpperCase();
                previewAvatarImgEl.classList.add('hidden');
                previewAvatarImgEl.src = '';
                previewAvatarTextEl.classList.remove('hidden');
                previewAvatarTextEl.parentElement.classList.remove('bg-indigo-600'); // Hapus kelas lama
                previewAvatarTextEl.parentElement.classList.add('bg-indigo-600'); // PERUBAHAN: Kembali ke bg-indigo-600
            }
            // --- AKHIR BARU ---
            
            // Reset to default "open bubble" state
            previewWindow.classList.remove('active');
            previewBubble.classList.remove('close-mode');
            previewBubble.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg><span>${buttonText}</span>`;

            // Show the container
            previewContainer.classList.remove('hidden');
        }

        function togglePreviewWidget() {
            const isActive = previewWindow.classList.toggle('active');
            if (isActive) {
                previewBubble.classList.add('close-mode');
                previewBubble.innerHTML = previewCloseIcon;
            } else {
                const buttonText = buttonTextInput.value.trim() || 'Tanya CS';
                previewBubble.classList.remove('close-mode');
                previewBubble.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg><span>${buttonText}</span>`;
            }
        }

        function updateStatus(message, type = 'info') {
            const statusEl = uploadStatus;
            statusEl.innerHTML = ''; // Clear previous content
            if (type === 'loading') {
                const spinner = document.createElement('div');
                spinner.className = 'spinner mx-auto';
                statusEl.appendChild(spinner);
            }
            const textEl = document.createElement('p');
            textEl.textContent = message;
            textEl.className = 'mt-2';
            statusEl.appendChild(textEl);
            
            statusEl.classList.remove('text-red-500', 'text-green-500', 'text-blue-500', 'text-[#E50914]', 'text-gray-300'); // Bersihkan semua
            if (type === 'error') statusEl.classList.add('text-[#E50914]'); // Merah Netflix untuk error
            else if (type === 'success') statusEl.classList.add('text-green-500'); // Tetap hijau untuk sukses
            else statusEl.classList.add('text-gray-300'); // Abu-abu muda untuk info
        }

        // --- FUNGSI BARU: Untuk kembali ke menu setup ---
        function backToSetup() {
            // 1. Sembunyikan tampilan embed
            embedView.classList.add('hidden');
            
            // 2. Tampilkan kembali tampilan setup
            setupView.classList.remove('hidden');

            // 3. Hapus widget live-preview yang sedang berjalan
            const liveWidget = document.getElementById('chat-on-container');
            if (liveWidget) liveWidget.remove();
            
            const liveStyle = document.getElementById('chat-on-widget-style');
            if (liveStyle) liveStyle.remove();

            // 4. Hapus pesan "Coba" dari tampilan embed
            const tryItMessage = document.getElementById('try-it-message');
            if (tryItMessage) tryItMessage.remove();

            // --- BARU: Reset input file avatar (tapi biarkan data yang tersimpan) ---
            avatarUploadInput.value = ''; 
            // Biarkan avatarPreviewSetup dan processedAvatarBase64 apa adanya
            // --- AKHIR BARU ---

            // 5. Bersihkan status "Membuat kode widget..." di tampilan setup
            if (uploadStatus.textContent.includes('Membuat kode widget')) {
                updateStatus(''); // Bersihkan hanya jika itu status proses, bukan status sukses upload
            }
        }
    });
    </script>
</body>
</html>
